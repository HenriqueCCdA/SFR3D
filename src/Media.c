#include<Media.h>
/********************************************************************* 
 * Data de criacao    : 03/02/2018                                   *
 * Data de modificaco : 00/00/0000                                   * 
 *-------------------------------------------------------------------* 
 * calMean : calcula media                                           *
 *-------------------------------------------------------------------* 
 * Parametros de entrada:                                            * 
 *-------------------------------------------------------------------* 
 * dt      -> deltaT                                                 *
 * t       -> tempo total                                            *
 * timeStep-> tempo total                                            *
 *-------------------------------------------------------------------* 
 * Parametros de saida:                                              * 
 *-------------------------------------------------------------------* 
 *-------------------------------------------------------------------* 
 * OBS:                                                              * 
 *-------------------------------------------------------------------* 
 *********************************************************************/
void calMean(Mean *media       , Mesh *mesh
           , DOUBLE const dt   , DOUBLE const t
           , INT const timeStep ) {


  if( timeStep == media->startSample)
    media->t0 = t;      


  if(timeStep >= media->startSample){
    if(media->f2pVel)
      prime2(media->mVel  , mesh->elm.vel
           , media->p2Vel
           , mesh->numel , mesh->ndm);

/*... calula e acumulada as integrais*/
    integralTemp(media, mesh,dt);

/*... calula a media*/
    calMediaTempFinal(media        , t
                    , mesh->numel  , mesh->ndm);
  }
/*...................................................................*/

}
/*********************************************************************/

/********************************************************************* 
 * Data de criacao    : 29/01/2018                                   *
 * Data de modificaco : 00/00/0000                                   * 
 *-------------------------------------------------------------------* 
 * integralTemp : calculo dos residuos no metodo simple              *
 *-------------------------------------------------------------------* 
 * Parametros de entrada:                                            * 
 *-------------------------------------------------------------------* 
 * dt    -> deltaT                                                   *
 * t     -> tempo total                                              *
 *-------------------------------------------------------------------* 
 * Parametros de saida:                                              * 
 *-------------------------------------------------------------------* 
 *-------------------------------------------------------------------* 
 * OBS:                                                              * 
 *-------------------------------------------------------------------* 
 *********************************************************************/
void integralTemp(Mean *media    , Mesh *mesh, DOUBLE const dt) {

  short j,ndm=mesh->ndm;
  INT nel;
  DOUBLE *v0,*v,*me,vm[3];

  media->fInit = true;

/*...*/
  for (nel = 0; nel < mesh->numel; nel++) {
/*...*/
    if (media->fVel) {
      v0 = mesh->elm.vel0;
      v  = mesh->elm.vel;
      me = media->sVel;
/*...*/
      for (j = 0; j < ndm; j++) {
        vm[j] = 0.5*(MAT2D(nel,j,v0,ndm) + MAT2D(nel,j,v,ndm));
        MAT2D(nel,j,me,ndm) += vm[j]*dt;
      }
/*...................................................................*/ 
    }
/*...................................................................*/

/*...*/
    if (media->f2pVel) {
      v  = media->p2Vel;
      me = media->sP2Vel;
/*...*/
      for (j = 0; j < ndm; j++) {
        vm[j] = MAT2D(nel,j,v,ndm);
        MAT2D(nel,j,me,ndm) += vm[j]*dt;
      }
/*...................................................................*/ 
    }
/*...................................................................*/
  }
/*...................................................................*/
}
/********************************************************************/ 

/********************************************************************* 
 * Data de criacao    : 29/01/2018                                   *
 * Data de modificaco : 00/00/0000                                   * 
 *-------------------------------------------------------------------* 
 * integralTemp : calculo dos residuos no metodo simple              *
 *-------------------------------------------------------------------* 
 * Parametros de entrada:                                            * 
 *-------------------------------------------------------------------* 
 * dt    -> deltaT                                                   *
 * n     -> numero total de pontos (numel,nnode)                     *
 * ndf   -> graus de liberade                                        *
 *-------------------------------------------------------------------* 
 * Parametros de saida:                                              * 
 *-------------------------------------------------------------------*
 * media                                                             *
 *-------------------------------------------------------------------* 
 * OBS:                                                              * 
 *-------------------------------------------------------------------* 
 *********************************************************************/
void  calMediaTempFinal(Mean *media, DOUBLE const t
                       , INT const n, short const ndf) 
{
  short j;
  INT i;
  DOUBLE *me,*se,tTotal;

  tTotal = t - media->t0;

  if(media->fInit){
    for (i = 0; i < n; i++) {

/*...*/
      if (media->fVel) {
        me = media->mVel;
        se = media->sVel;
/*...*/
        for (j = 0; j < ndf; j++) 
          MAT2D(i,j,me,ndf) =  MAT2D(i,j,se,ndf)/tTotal;      
/*...................................................................*/ 
      }
/*...................................................................*/

/*...*/
      if (media->f2pVel) {
        me = media->mP2Vel;
        se = media->sP2Vel;
/*...*/
        for (j = 0; j < ndf; j++) 
          MAT2D(i,j,me,ndf) =  MAT2D(i,j,se,ndf)/tTotal;      
/*...................................................................*/ 
      }
/*...................................................................*/
    }
/*...................................................................*/
  }
/*...................................................................*/
}
/*********************************************************************/

/********************************************************************* 
 * Data de criacao    : 30/01/2018                                   *
 * Data de modificaco : 00/00/0000                                   * 
 *-------------------------------------------------------------------* 
 * prime2 : phi(x,t)'' = phi(x,t) - <phi>(x,t)                       *
 *-------------------------------------------------------------------* 
 * Parametros de entrada:                                            * 
 *-------------------------------------------------------------------* 
 * mPhi  -> media de velocidade (<vel>)                              *
 * phi   -> velocidade                                               *
 * p2Phi -> nao defindio                                             * 
 * n     -> numero total de pontos (numel,nnode)                     *
 * ndf   -> graus de liberade                                        *
 *-------------------------------------------------------------------* 
 * Parametros de saida:                                              * 
 *-------------------------------------------------------------------*
 * p2Vel -> vel(x,t) - <vel>(x,t)                                    *
 *-------------------------------------------------------------------* 
 * OBS:                                                              * 
 *-------------------------------------------------------------------* 
 *********************************************************************/
void  prime2(DOUBLE *RESTRICT mPhi , DOUBLE *RESTRICT phi
           , DOUBLE *RESTRICT p2Phi
           , INT const n           , short const ndf) 
{
  short j;
  INT i;

  for (i = 0; i < n; i++) {

    for (j = 0; j < ndf; j++) 
      MAT2D(i,j,p2Phi,ndf) =  MAT2D(i,j,phi,ndf) - MAT2D(i,j,mPhi,ndf);      
/*...................................................................*/ 
  }
/*...................................................................*/
}